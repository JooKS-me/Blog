---
title: "关于博客的一些新想法"
date: Sat Mar 20 00:23:33 CST 2021
categories: 项目
tags: 项目
draft: false
---

下面是示意图。

![示意图](https://img.jooks.cn/img/20210320001839.jpg)

但是感觉工程量有点大，有空再做吧～

---

2021.03.22 00:04更新

现在已经完成了注册模块。

这里用到了谷歌的recaptcha人机验证的API，用户在网页上点完谷歌的那几个魔鬼图片，然后会得到一个token，将这个token和服务端密钥一起传给 `"https://recaptcha.net/recaptcha/api/siteverify?secret={1}&response={2}"` 即可得到是否验证成功，访问的域名是什么这些信息。

通过这个验证之后才能发送邮箱验证码。这里的验证码会放在redis中，10分钟过期。

邮箱验证码这里分成两个重要点：随机字符串生成 + SMTP发送邮件。

这里po一下相关代码～

随机字符串生成
```java
public class CodeUtils {
    /**
     * 获取随机字符串
     * @param length 字符串长度
     * @return 随机字符串
     */
    public static String getCharAndNum(int length) {
        StringBuilder ans = new StringBuilder();
        Random random = new Random();
        for (int i = 0; i < length; i++) {
            int flag = random.nextInt(2) % 2;
            if (flag == 1) { //字母
                int base = random.nextInt(2) % 2 == 0 ? 65 : 97;  // 大写 or 小写
                ans.append((char) (base + random.nextInt(26)));
            } else { //数字
                ans.append(random.nextInt(10));
            }
        }
        return ans.toString();
    }
}
```

SMTP发送邮件（这里直接使用了javax.mail包）
```java
public class MyClientSend {
    private Session session;
    private Transport transport;
    private String username = "joo_k_s@163.com";
    private String password = "你的授权码";
    private String smtpServer = "smtp.163.com";

    public void init()throws Exception
    {
        //设置属性
        Properties props = new Properties();
        props.put("mail.transport.protocol", "smtp");
        props.put("mail.smtp.class", "com.sun.mail.smtp.SMTPTransport");
        props.put("mail.smtp.host", smtpServer); //设置发送邮件服务器
        props.put("mail.smtp.port", "25");
        props.put("mail.smtp.auth", "true"); //SMTP服务器需要身份验证

        // 创建Session对象
        session = Session.getInstance(props,new Authenticator(){   //验账账户
            public PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(username, password);
            }
        });
        session.setDebug(false); //输出跟踪日志

        // 创建Transport对象
        transport = session.getTransport();
    }

    public void sendMessage(String to, String code)throws Exception{
        //创建一个邮件
        Message msg = HtmlMessage.generate(to, code);
        //发送邮件
        transport.connect();
        transport.sendMessage(msg, msg.getAllRecipients());
    }

    public void close()throws Exception
    {
        transport.close();
    }
}
```

```java
public class HtmlMessage {
    public static MimeMessage generate(String to, String code) throws Exception
    {
        String from = "joo_k_s@163.com"; // 发件人地址

        String subject = "注册验证码 - JooKS的小站";
        String body = "欢迎来到JooKS的小站：<a href=\"https://www.jooks.cn/index\">我的首页</a><br>"
                + "下面是您的验证码 (10分钟内有效) : <br>"
                + "<h1>" + code + "</h1>";

        // 创建Session实例对象
        Session session = Session.getDefaultInstance(new Properties());
        // 创建MimeMessage实例对象
        MimeMessage message = new MimeMessage(session);
        // 设置发件人
        message.setFrom(new InternetAddress(from));
        // 设置收件人
        message.setRecipients(Message.RecipientType.TO, InternetAddress.parse(to));
        // 设置发送日期
        message.setSentDate(new Date());
        // 设置邮件主题
        message.setSubject(subject);
        // 设置HTML格式的邮件正文
        message.setContent(body, "text/html;charset=gb2312");
        // 保存并生成最终的邮件内容
        message.saveChanges();

        return message;
    }
}
```

